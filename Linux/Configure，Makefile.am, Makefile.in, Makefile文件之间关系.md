## Configure，Makefile.am, Makefile.in, Makefile文件之间关系					

![Makefile](.\image\Makefile.jpg)

<TABLE style="WIDTH: 100%; TABLE-LAYOUT: auto">
<TBODY>
<TR>
<TD>
<DIV id=blog_text class=cnt><SPAN style="LINE-HEIGHT: 18px" class=Apple-style-span>
<DIV style="POSITION: static; FILTER: none; LINE-HEIGHT: 20px; WORD-WRAP: break-word; VISIBILITY: visible !important; COLOR: rgb(51,51,51); FONT-SIZE: 14px; OVERFLOW: hidden" class=cnt>
<P style="LINE-HEIGHT: normal">1.autoscan (autoconf): 扫描源代码以搜寻普通的可移植性问题，比如检查编译器，库，头文件等，生成文件configure.scan,它是configure.ac的一个雏形。</P>
<P style="LINE-HEIGHT: normal">&nbsp;&nbsp;&nbsp; your source files --&gt; [autoscan*] --&gt; [configure.scan] --&gt; configure.ac</P>2.aclocal (automake):根据已经安装的宏，用户定义宏和acinclude.m4文件中的宏将configure.ac文件所需要的宏集中定义到文件 aclocal.m4中。aclocal是一个perl 脚本程序，它的定义是：“aclocal - create aclocal.m4 by scanning configure.ac” <PRE style="LINE-HEIGHT: normal" class=example>user input files   optional input     process          output files<BR>================   ==============     =======          ============<BR><BR>                    acinclude.m4 - - - - -.<BR>                                          V<BR>                                      .-------,<BR>configure.ac ------------------------&gt;|aclocal|<BR>                 {user macro files} -&gt;|       |------&gt; aclocal.m4<BR>                                      `-------'<BR>3.autoheader(autoconf): 根据configure.ac中的某些宏，比如cpp宏定义，运行m4，声称config.h.in<BR><BR>user input files    optional input     process          output files<BR>================    ==============     =======          ============<BR><BR>                    aclocal.m4 - - - - - - - .<BR>                                             |<BR>                                             V<BR>                                     .----------,<BR>configure.ac -----------------------&gt;|autoheader|----&gt; autoconfig.h.in<BR>                                     `----------'</PRE>
<P style="LINE-HEIGHT: normal">4.automake: automake将Makefile.am中定义的结构建立Makefile.in，然后configure脚本将生成的Makefile.in文件转换 为Makefile。如果在configure.ac中定义了一些特殊的宏，比如AC_PROG_LIBTOOL，它会调用libtoolize，否则它 会自己产生config.guess和config.sub</P><PRE style="LINE-HEIGHT: normal" class=example>user input files   optional input   processes          output files<BR>================   ==============   =========          ============<BR><BR>                                     .--------,<BR>                                     |        | - - -&gt; COPYING<BR>                                     |        | - - -&gt; INSTALL<BR>                                     |        |------&gt; install-sh<BR>                                     |        |------&gt; missing<BR>                                     |automake|------&gt; mkinstalldirs<BR>configure.ac -----------------------&gt;|        |<BR>Makefile.am  -----------------------&gt;|        |------&gt; Makefile.in<BR>                                     |        |------&gt; stamp-h.in<BR>                                 .---+        | - - -&gt; config.guess<BR>                                 |   |        | - - -&gt; config.sub<BR>                                 |   `------+-'<BR>                                 |          | - - - -&gt; config.guess<BR>                                 |libtoolize| - - - -&gt; config.sub<BR>                                 |          |--------&gt; ltmain.sh<BR>                                 |          |--------&gt; ltconfig<BR>                                 `----------'</PRE>
<P style="LINE-HEIGHT: normal">5.autoconf:将configure.ac中的宏展开，生成configure脚本。这个过程可能要用到aclocal.m4中定义的宏。</P><PRE style="LINE-HEIGHT: normal" class=example>user input files   optional input   processes          output files<BR>================   ==============   =========          ============<BR><BR>aclocal.m4 ,autoconfig.h.in - - - - - - -.<BR>                                         V<BR>                                     .--------,<BR>configure.ac -----------------------&gt;|autoconf|------&gt; configure</PRE><PRE style="LINE-HEIGHT: normal" class=example> </PRE><PRE style="LINE-HEIGHT: normal" class=example>6. ./configure的过程</PRE><PRE style="LINE-HEIGHT: normal" class=example><BR style="LINE-HEIGHT: normal">                                           .-------------&gt; [config.cache]<BR>     configure* --------------------------+-------------&gt; config.log<BR>                                          |<BR>              [config.h.in] -.            v            .--&gt; [autoconfig.h]<BR style="LINE-HEIGHT: normal">                             +-------&gt; config.status* -+                   <BR>              Makefile.in ---'                         `--&gt;   Makefile</PRE><PRE style="LINE-HEIGHT: normal" class=example> </PRE><PRE style="LINE-HEIGHT: normal" class=example>7. make过程</PRE><PRE style="LINE-HEIGHT: normal" class=example> </PRE><PRE style="LINE-HEIGHT: normal" class=example>[autoconfig.h] -.<BR style="LINE-HEIGHT: normal">                     +--&gt; make* ---&gt;  程序<BR style="LINE-HEIGHT: normal">        Makefile   ---'</PRE><PRE style="LINE-HEIGHT: normal" class=example> </PRE><PRE style="LINE-HEIGHT: normal" class=example>.---------,<BR>                   config.site - - -&gt;|         |<BR>                  config.cache - - -&gt;|<STRONG style="LINE-HEIGHT: normal"><U style="LINE-HEIGHT: normal">configure</U></STRONG>| - - -&gt; config.cache<BR>                                     |         +-,<BR>                                     `-+-------' |<BR>                                       |         |----&gt; config.status<BR>                   config.h.in -------&gt;|config-  |----&gt; config.h<BR>                   Makefile.in -------&gt;|  .status|----&gt; Makefile<BR>                                       |         |----&gt; stamp-h<BR>                                       |         +--,<BR>                                     .-+         |  |<BR>                                     | `------+--'  |<BR>                   ltmain.sh -------&gt;|ltconfig|-------&gt; libtool<BR>                                     |        |     |<BR>                                     `-+------'     |<BR>                                       |config.guess|<BR>                                       | config.sub |<BR>                                       `------------'<P style="LINE-HEIGHT: normal"> </P><PRE style="LINE-HEIGHT: normal">.--------,<BR>                   Makefile ------&gt;|        |<BR>                   config.h ------&gt;|  <STRONG style="LINE-HEIGHT: normal"><U style="LINE-HEIGHT: normal">make</U></STRONG>  |<BR>{project sources} ----------------&gt;|        |--------&gt; {project targets}<BR>                                 .-+        +--,<BR>                                 | `--------'  |<BR>                                 |   libtool   |<BR>                                 |   missing   |<BR>                                 |  install-sh |<BR>                                 |mkinstalldirs|<BR>                                 `-------------'</PRE>
</PRE></DIV></SPAN><FONT color=#ff0000>实例</FONT>：<BR>在/hello/目录下创建一个hello.c文件，并编译运行它：
<P>#cd /hello/</P>
<P>(1) 编写源文件hello.c：</P>
<P>#include&lt;stdio.h&gt; <BR>int main(int argc, char** argv)<BR>{<BR>printf("Hello, GNU!n");<BR>return 0;<BR>}</P>
<P>[litao@vm0000131 hello]$ ll<BR>total 4<BR>-rw-rw-r-- 1 litao litao 68 Aug 12 12:02 hello.c</P>
<P>一、autoscan</P>
<P><FONT color=#ff0000>[litao@vm0000131 hello]$ autoscan</FONT><BR>autom4te: configure.ac: no such file or directory<BR>autoscan: /usr/bin/autom4te failed with exit status: 1<BR>[litao@vm0000131 hello]$ ll<BR>total 8<BR>-rw-rw-r-- 1 litao litao&nbsp;&nbsp; 0 Aug 12 12:03 autoscan.log<BR>-rw-rw-r-- 1 litao litao 457 Aug 12 12:03 configure.scan<BR>-rw-rw-r-- 1 litao litao&nbsp; 68 Aug 12 12:02 hello.c</P>
<P><FONT color=#ff0000>已经生成了configure.scan，autoscan.log文件</FONT></P>
<P><SPAN>将configure.scan 修改为 <SPAN class=IL_SPAN>configure</SPAN>.in，最后修改的内容如下：</SPAN></P>
<P><FONT color=#ff0000><FONT color=#000000><FONT color=#ff0000>[litao@vm0000131 hello]$ mv configure.scan configure.in&nbsp;&nbsp;</FONT>&nbsp; <BR><FONT color=#ff0000>[litao@vm0000131 hello]$ vim configure.in</FONT> <BR></FONT></FONT></P>
<P><FONT color=#ff0000><FONT color=#000000>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -*- Autoconf -*-<BR># Process this file with autoconf to produce a configure script.<BR><BR>AC_PREREQ(2.59)<BR>AC_INIT(FULL-PACKAGE-NAME, VERSION, BUG-REPORT-ADDRESS)<BR>AC_CONFIG_SRCDIR([hello.c])<BR>#AC_CONFIG_HEADER([config.h])<BR>AM_INIT_AUTOMAKE(hello, 1.0)<BR># Checks for programs.<BR>AC_PROG_CC<BR><BR># Checks for libraries.<BR><BR># Checks for header files.<BR><BR># Checks for typedefs, structures, and compiler characteristics.<BR><BR># Checks for library functions.<BR>AC_OUTPUT(Makefile)</FONT></FONT></P>
<P><FONT color=#ff0000><FONT color=#000000>二、acloacl</FONT><BR></FONT></P>
<P><FONT color=#ff0000>[litao@vm0000131 hello]$ aclocal <BR></FONT></P>
<P><FONT color=#ff0000>生成 aclocal.m4 和 autom4te.cache (生成aclocal.m4的过程中涉及到configure.in)</FONT></P>
<P><FONT color=#ff0000><FONT color=#000000>[litao@vm0000131 hello]$ ll<BR>total 44<BR>-rw-rw-r-- 1 litao litao 31120 Aug 12 12:08 aclocal.m4<BR>drwxr-xr-x 2 litao litao&nbsp; 4096 Aug 12 12:08 autom4te.cache<BR>-rw-rw-r-- 1 litao litao&nbsp;&nbsp;&nbsp;&nbsp; 0 Aug 12 12:03 autoscan.log<BR>-rw-rw-r-- 1 litao litao&nbsp;&nbsp; 496 Aug 12 12:08 configure.in<BR>-rw-rw-r-- 1 litao litao&nbsp;&nbsp;&nbsp; 68 Aug 12 12:02 hello.c</FONT></FONT></P>
<P><FONT color=#ff0000><FONT color=#000000>三、antoconf<BR></FONT></FONT></P><FONT color=#ff0000>[litao@vm0000131 hello]$ autoconf<BR><SPAN>生成 <SPAN class=IL_SPAN>configure</SPAN> (根据 <SPAN class=IL_SPAN>configure</SPAN>.in, 和 aclocal.m4)</SPAN></FONT><BR>[litao@vm0000131 hello]$ ll<BR>total 168<BR>-rw-rw-r-- 1 litao litao&nbsp; 31120 Aug 12 12:08 aclocal.m4<BR>drwxr-xr-x 2 litao litao&nbsp;&nbsp; 4096 Aug 12 12:11 autom4te.cache<BR>-rw-rw-r-- 1 litao litao&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 Aug 12 12:03 autoscan.log<BR>-rwxrwxr-x 1 litao litao 122297 Aug 12 12:11 configure<BR>-rw-rw-r-- 1 litao litao&nbsp;&nbsp;&nbsp; 496 Aug 12 12:08 configure.in<BR>-rw-rw-r-- 1 litao litao&nbsp;&nbsp;&nbsp;&nbsp; 68 Aug 12 12:02 hello.c<BR><BR>四、编写Makefile.am：
<P>AUTOMAKE_OPTIONS= foreign<BR>bin_PROGRAMS= hello<BR>hello_SOURCES= hello.c</P>五、automake
<P>生成 Makefile.in， depcomp， install-sh， 和 missing (根据 Makefile.am, 和 aclocal.m4)</P>
<P><FONT color=#ff0000>[litao@vm0000131 hello]$ automake</FONT><BR>configure.in: required file `./install-sh' not found<BR>configure.in: required file `./missing' not found<BR>Makefile.am: required file `./depcomp' not found<BR><FONT color=#ff0000>[litao@vm0000131 hello]$ automake --add-missing</FONT><BR>configure.in: installing `./install-sh'<BR>configure.in: installing `./missing'<BR>Makefile.am: installing `./depcomp'<BR>[litao@vm0000131 hello]$ ll<BR>total 192<BR>-rw-rw-r-- 1 litao litao&nbsp; 31120 Aug 12 12:08 aclocal.m4<BR>drwxr-xr-x 2 litao litao&nbsp;&nbsp; 4096 Aug 12 12:14 autom4te.cache<BR>-rw-rw-r-- 1 litao litao&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 Aug 12 12:03 autoscan.log<BR>-rwxrwxr-x 1 litao litao 122297 Aug 12 12:11 configure<BR>-rw-rw-r-- 1 litao litao&nbsp;&nbsp;&nbsp; 496 Aug 12 12:08 configure.in<BR>lrwxrwxrwx 1 litao litao&nbsp;&nbsp;&nbsp;&nbsp; 31 Aug 12 12:16 depcomp -&gt; /usr/share/automake-1.9/depcomp<BR>-rw-rw-r-- 1 litao litao&nbsp;&nbsp;&nbsp;&nbsp; 68 Aug 12 12:02 hello.c<BR>lrwxrwxrwx 1 litao litao&nbsp;&nbsp;&nbsp;&nbsp; 34 Aug 12 12:16 install-sh -&gt; /usr/share/automake-1.9/install-sh<BR>-rw-rw-r-- 1 litao litao&nbsp;&nbsp;&nbsp;&nbsp; 69 Aug 12 12:15 Makefile.am<BR>-rw-rw-r-- 1 litao litao&nbsp; 16561 Aug 12 12:16 Makefile.in<BR>lrwxrwxrwx 1 litao litao&nbsp;&nbsp;&nbsp;&nbsp; 31 Aug 12 12:16 missing -&gt; /usr/share/automake-1.9/missing</P>
<P>六、configure<BR>生成 Makefile， config.log， 和 config.status</P></DIV></TD></TR></TBODY></TABLE>




